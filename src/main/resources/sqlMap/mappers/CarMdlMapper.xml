<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ys.carInfo.carMdl.mapper.CarMdlMapper">

	<insert id="mergeCarMdl" parameterType="com.ys.carInfo.carMdl.vo.CarMdlVo">
		<selectKey resultType="String" keyProperty="carMdlNo" order="BEFORE">
			<choose>
			<when test="carMdlNo != null and carMdlNo != ''">
				SELECT 	#{carMdlNo,jdbcType=VARCHAR} CAR_MDL_NO
				FROM 	DUAL
			</when>
			<otherwise>
				SELECT	'CM' || TO_CHAR(SYSDATE, 'YYYYMMDD') || SUBSTR(10000 + CAR_MDL_SEQ.NEXTVAL, -4) CAR_MDL_NO
				FROM 	DUAL
			</otherwise>
			</choose>
		</selectKey>
		MERGE 	INTO CAR_MDL 	M
		USING 	(
					SELECT
							#{carMdlNo,jdbcType=VARCHAR}	CAR_MDL_NO
						  , #{carMdlNm,jdbcType=VARCHAR}	CAR_MDL_NM
						  , #{carMdlClCd,jdbcType=VARCHAR}	CAR_MDL_CL_CD
						  , #{upCarMdlNo,jdbcType=VARCHAR}	UP_CAR_MDL_NO
						  , #{mnfNo,jdbcType=VARCHAR}		MNF_NO
						  , #{carAprnCd,jdbcType=VARCHAR}	CAR_APRN_CD
						  , #{carKnCd,jdbcType=VARCHAR}		CAR_KN_CD
						  , #{rlsYear,jdbcType=VARCHAR}		RLS_YEAR
						  , #{regNo,jdbcType=INTEGER}		REG_NO
						  , SYSDATE							REG_DTT
						  , #{modNo,jdbcType=INTEGER}		MOD_NO
						  , SYSDATE							MOD_DTT
					FROM 	DUAL
				)	S
		ON 		(M.CAR_MDL_NO = S.CAR_MDL_NO)
		WHEN 	MATCHED THEN
				UPDATE	SET
						M.CAR_MDL_NM 	= S.CAR_MDL_NM
					  , M.MNF_NO 		= S.MNF_NO
					  , M.CAR_APRN_CD 	= S.CAR_APRN_CD
					  , M.CAR_KN_CD 	= S.CAR_KN_CD
					  , M.DEL_YN 		= 'N'
					  , M.MOD_NO 		= S.MOD_NO
					  , M.MOD_DTT		= S.MOD_DTT
		WHEN 	NOT MATCHED THEN
				INSERT 	(
							CAR_MDL_NO
						  , CAR_MDL_NM
						  , CAR_MDL_CL_CD
						  , UP_CAR_MDL_NO
						  , MNF_NO
						  , CAR_APRN_CD
						  , CAR_KN_CD
						  , RLS_YEAR
						  , SRT_ORD
						  , REG_NO
						  , REG_DTT
						  , MOD_NO
						  , MOD_DTT
						)
				VALUES	(
							S.CAR_MDL_NO
						  , S.CAR_MDL_NM
						  , S.CAR_MDL_CL_CD
						  , S.UP_CAR_MDL_NO
						  , S.MNF_NO
						  , S.CAR_APRN_CD
						  , S.CAR_KN_CD
						  , S.RLS_YEAR
						  , (SELECT NVL(MAX(SRT_ORD) + 1, 1) FROM CAR_MDL WHERE UP_CAR_MDL_NO = #{upCarMdlNo,jdbcType=VARCHAR})
						  , S.REG_NO
						  , S.REG_DTT
						  , S.MOD_NO
						  , S.MOD_DTT
						)
	</insert>

	<select id="selectCarMdl" parameterType="String" resultType="com.ys.carInfo.carMdl.vo.CarMdlVo">
		SELECT
		        CM.CAR_MDL_NO
		      , CM.CAR_MDL_NM
		      , CM.CAR_MDL_CL_CD
		      , CM.UP_CAR_MDL_NO
		      , CM.MNF_NO
		      , MF.MNF_NM
		      , AF.FILE_NO 		MNF_FILE_NO
		      , CM.CAR_APRN_CD
		      , C.CMN_CD_NM		CAR_APRN_NM
		      , CM.CAR_KN_CD
		      , C2.CMN_CD_NM 	CAR_KN_NM
		      , TO_CHAR(CM.REG_DTT, 'YYYY-MM-DD') REG_DT
		FROM    CAR_MDL 	CM
			  , CMN_CODE 	C
		      , CMN_CODE 	C2
		      , MNF     	MF
		      , ATCH_FILE   AF
		WHERE   1 = 1
		AND     CM.CAR_MDL_NO = #{carMdlNo,jdbcType=VARCHAR}
		AND     CM.DEL_YN = 'N'
		AND 	CM.CAR_APRN_CD = C.CMN_CD
		AND 	CM.CAR_KN_CD = C2.CMN_CD
		AND     CM.MNF_NO = MF.MNF_NO
		AND     MF.DEL_YN = 'N'
		AND     MF.MNF_NO = AF.FILE_IDNT_NO
		AND     AF.DEL_YN = 'N'
	</select>

	<select id="selectCarInfoList" parameterType="HashMap" resultType="HashMap">
		SELECT	*
		FROM 	CAR_MDL
	</select>


</mapper>